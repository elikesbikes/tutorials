# ------------------------------------------------------------
# docker-compose.yml
#
# Service: syncthing-health
# Version: 1.7.0
#
# Description:
# Syncthing health, device sync lag, and device offline monitoring
# endpoints exposed over HTTP for Uptime Kuma, with transition-based
# ntfy alerts.
#
# Endpoints:
#   - Port 9123: Overall Syncthing health
#   - Port 9124: Device-specific sync lag monitor
#   - Port 9125: Device offline / last-seen monitor
#
# Design notes:
# - Uses a prebuilt Alpine image with dependencies baked in
# - NO runtime apk installs (production-safe)
# - NO top-level 'version:' key (Compose v2 rule)
# - Single container, multiple listeners
#
# Changelog (running):
# - 1.7.0: Add device offline (last-seen) monitoring endpoint on port 9125
# - 1.6.0: Move all dependencies to Dockerfile; remove runtime apk installs
# - 1.5.0: Add second HTTP endpoint (port 9124) for device sync lag monitoring
# - 1.4.0: Add persistent state volume for transition-based ntfy notifications
# - 1.2.4: Removed obsolete top-level 'version:' key (Compose v2 rule)
# - 1.2.3: Fix socat PATH issue by using absolute binary path
# - 1.2.2: Fix invalid HTTP responses by switching from nc to socat
# - 1.2.1: Converted changelog to cumulative format
# - 1.2.0: Added optional debug logging
# - 1.1.2: Added bash runtime dependency
# - 1.1.1: Fixed RO volume startup failure
# - 1.1.0: Added external frontend Docker network
# ------------------------------------------------------------

services:
  syncthing-health:
    container_name: syncthing-health

    # Build locally to guarantee bash, curl, jq, socat availability
    build:
      context: .
      dockerfile: Dockerfile

    env_file:
      - /home/ecloaiza/.syncthing-health.env

    ports:
      - "9123:9123"   # Overall Syncthing health
      - "9124:9124"   # Device sync lag monitor
      - "9125:9125"   # Device offline / last-seen monitor

    networks:
      - frontend

    volumes:
      - ./syncthing_health.sh:/app/syncthing_health.sh:ro
      - ./syncthing_health_http.sh:/app/syncthing_health_http.sh:ro
      - ./syncthing-device-sync-monitor.sh:/app/syncthing-device-sync-monitor.sh:ro
      - ./syncthing_device_lag_http.sh:/app/syncthing_device_lag_http.sh:ro

      # Device offline / last-seen monitor
      - ./syncthing-device-offline-monitor.sh:/app/syncthing-device-offline-monitor.sh:ro
      - ./syncthing_device_offline_http.sh:/app/syncthing_device_offline_http.sh:ro

      # Persistent state + logs
      - ./state:/state

      # Explicit env mount for container root user
      - /home/ecloaiza/.syncthing-health.env:/root/.syncthing-health.env:ro

    command: >
      sh -c "
        /usr/bin/socat TCP-LISTEN:9123,reuseaddr,fork EXEC:'/bin/bash /app/syncthing_health_http.sh' &
        /usr/bin/socat TCP-LISTEN:9124,reuseaddr,fork EXEC:'/bin/bash /app/syncthing_device_lag_http.sh' &
        /usr/bin/socat TCP-LISTEN:9125,reuseaddr,fork EXEC:'/bin/bash /app/syncthing_device_offline_http.sh' &
        wait
      "

    restart: unless-stopped

networks:
  frontend:
    external: true
