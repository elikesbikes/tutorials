# ------------------------------------------------------------
# docker-compose.yml
#
# Service: syncthing-health
# Version: 1.4.0
#
# Description:
# Bash-based Syncthing health endpoint exposed over HTTP
# for monitoring via Uptime Kuma, with optional ntfy notifications.
#
# Changelog (running):
# - 1.4.0: Add persistent state volume for transition-based ntfy notifications
# - 1.2.4: Removed obsolete top-level 'version:' key (Compose v2 rule)
# - 1.2.3: Fix socat PATH issue by using absolute binary path
# - 1.2.2: Fix invalid HTTP responses by switching from nc to socat
# - 1.2.1: Converted changelog to cumulative format
# - 1.2.0: Added optional debug logging
# - 1.1.2: Added bash runtime dependency
# - 1.1.1: Fixed RO volume startup failure
# - 1.1.0: Added external frontend Docker network
# ------------------------------------------------------------

services:
  syncthing-health:
    image: alpine:3.20
    container_name: syncthing-health

    env_file:
      - /home/ecloaiza/.syncthing-health.env

    ports:
      - "9123:9123"

    networks:
      - frontend

    volumes:
      - ./syncthing_health.sh:/app/syncthing_health.sh:ro
      - ./syncthing_health_http.sh:/app/syncthing_health_http.sh:ro
      - ./syncthing-device-sync-monitor.sh:/app/syncthing-device-sync-monitor.sh:ro
      - ./state:/state  
      
    command: >
      sh -c "
        apk add --no-cache bash curl jq socat &&
        /app/syncthing_health_http.sh
      "

    restart: unless-stopped

networks:
  frontend:
    external: true
