# ------------------------------------------------------------
# docker-compose.yml
#
# Service: syncthing-health
# Version: 1.5.0
#
# Description:
# Bash-based Syncthing health endpoints exposed over HTTP
# for monitoring via Uptime Kuma, with optional ntfy notifications.
#
# Endpoints:
#   - Port 9123: Overall Syncthing health
#   - Port 9124: Device-specific sync lag monitor
#
# Changelog (running):
# - 1.5.0: Add second HTTP endpoint (port 9124) for device sync lag monitoring
# - 1.4.0: Add persistent state volume for transition-based ntfy notifications
# - 1.2.4: Removed obsolete top-level 'version:' key (Compose v2 rule)
# - 1.2.3: Fix socat PATH issue by using absolute binary path
# - 1.2.2: Fix invalid HTTP responses by switching from nc to socat
# - 1.2.1: Converted changelog to cumulative format
# - 1.2.0: Added optional debug logging
# - 1.1.2: Added bash runtime dependency
# - 1.1.1: Fixed RO volume startup failure
# - 1.1.0: Added external frontend Docker network
# ------------------------------------------------------------

services:
  syncthing-health:
    image: alpine:3.20
    container_name: syncthing-health

    env_file:
      - /home/ecloaiza/.syncthing-health.env

    ports:
      - "9123:9123"   # Existing Syncthing health
      - "9124:9124"   # Device sync lag monitor

    networks:
      - frontend

    volumes:
      - ./syncthing_health.sh:/app/syncthing_health.sh:ro
      - ./syncthing_health_http.sh:/app/syncthing_health_http.sh:ro
      - ./syncthing-device-sync-monitor.sh:/app/syncthing-device-sync-monitor.sh:ro
      - ./syncthing_device_lag_http.sh:/app/syncthing_device_lag_http.sh:ro
      - ./state:/state

    command: >
      sh -c "
        apk add --no-cache bash curl jq socat &&
        /usr/bin/socat TCP-LISTEN:9123,reuseaddr,fork EXEC:'/bin/bash /app/syncthing_health_http.sh' &
        exec /usr/bin/socat TCP-LISTEN:9124,reuseaddr,fork EXEC:'/bin/bash /app/syncthing_device_lag_http.sh'
      "


    restart: unless-stopped

networks:
  frontend:
    external: true
